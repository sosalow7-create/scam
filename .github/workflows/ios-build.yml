name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Show project structure
      run: |
        echo "ðŸ“ Project structure:"
        ls -la
        echo ""
        echo "ðŸ“± Swift files:"
        find . -name "*.swift" -type f
    
    - name: List available schemes
      run: |
        echo "ðŸ“‹ Checking available schemes..."
        xcodebuild -list
        echo ""
        echo "ðŸ“‹ Checking Swift Package..."
        swift package describe
      continue-on-error: true
    
    - name: Build library with Swift
      run: |
        echo "ðŸ”¨ Building SCAM library..."
        swift build -c release
        echo "âœ… Build completed!"
      continue-on-error: true
    
    - name: Create unsigned IPA
      run: |
        echo "ðŸ“¦ Creating IPA from compiled app..."
        
        # Find the built .app
        APP_PATH=$(find DerivedData -name "*.app" -type d | grep -v "Intermediates" | head -n 1)
        
        if [ -z "$APP_PATH" ]; then
          echo "âŒ Built app not found!"
          echo "Creating fallback IPA with sources..."
          mkdir -p build/Payload/SCAM.app
          cp -r Sources/SCAM/* build/Payload/SCAM.app/
          cp -r Info.plist build/Payload/SCAM.app/
        else
          echo "âœ… Found app: $APP_PATH"
          
          # Create Payload folder
          mkdir -p build/Payload
          
          # Copy app to Payload
          cp -r "$APP_PATH" build/Payload/
          
          # Show contents
          ls -la build/Payload/
          ls -la build/Payload/*.app/
        fi
        
        # Create IPA
        cd build
        zip -r SCAM.ipa Payload
        cd ..
        
        echo "âœ… IPA created!"
        ls -lh build/SCAM.ipa
        unzip -l build/SCAM.ipa | head -20
    
    - name: Package artifacts
      run: |
        mkdir -p artifacts
        
        # Source code
        zip -r artifacts/SCAM-Source.zip . \
          -x "*.git*" \
          -x "*build/*" \
          -x "*artifacts/*" \
          -x "*.DS_Store"
        
        # Copy IPA if exists
        if [ -f build/SCAM.ipa ]; then
          cp build/SCAM.ipa artifacts/
        fi
        
        echo "ðŸ“¦ Artifacts packaged"
    
    - name: Upload IPA
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SCAM-iOS-App
        path: artifacts/SCAM.ipa
        retention-days: 30
    
    - name: Upload Source
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SCAM-Source-Code
        path: artifacts/SCAM-Source.zip
        retention-days: 30
    
    - name: Build Summary
      run: |
        echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**SCAM Messenger** iOS app built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- Swift files: $(find . -name '*.swift' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Views: $(find Views -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Models: $(find Models -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- ViewModels: $(find ViewModels -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "- **SCAM.ipa** - iOS app (unsigned, for simulator)" >> $GITHUB_STEP_SUMMARY
        echo "- **Source code** - Complete project files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Note" >> $GITHUB_STEP_SUMMARY
        echo "This is an unsigned build. To install on device, you need to:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open project in Xcode" >> $GITHUB_STEP_SUMMARY
        echo "2. Select your team for code signing" >> $GITHUB_STEP_SUMMARY
        echo "3. Build and run on your device" >> $GITHUB_STEP_SUMMARY
