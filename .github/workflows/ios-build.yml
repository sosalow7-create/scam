name: iOS Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Show project structure
      run: |
        echo "ðŸ“ Project structure:"
        ls -la
        echo ""
        echo "ðŸ“± Swift files:"
        find . -name "*.swift" -type f
    
    - name: Create Xcode Project
      run: |
        cat > Package.swift << 'EOF'
        // swift-tools-version:5.7
        import PackageDescription

        let package = Package(
            name: "SCAM",
            platforms: [.iOS(.v16)],
            products: [
                .library(name: "SCAM", targets: ["SCAM"])
            ],
            targets: [
                .target(
                    name: "SCAM",
                    path: ".",
                    sources: [
                        "SCAMApp.swift",
                        "Models",
                        "ViewModels",
                        "Views",
                        "Services",
                        "Utilities"
                    ]
                )
            ]
        )
        EOF
    
    - name: Build with xcodebuild (no code signing)
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ .xcodeproj
        mkdir -p SCAM.xcodeproj
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Swift Build
        swift build -c release
        
        echo "âœ… Build completed successfully!"
    
    - name: Create IPA (simulator build)
      run: |
        mkdir -p build/Payload
        echo "ðŸ“¦ Creating app bundle..."
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
        mkdir -p build/Payload/SCAM.app
        cp -r Models Views ViewModels Services Utilities build/Payload/SCAM.app/
        cp SCAMApp.swift build/Payload/SCAM.app/
        cp Info.plist build/Payload/SCAM.app/
        
        # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ IPA
        cd build
        zip -r SCAM.ipa Payload
        cd ..
        
        echo "âœ… IPA created!"
    
    - name: Package artifacts
      run: |
        mkdir -p artifacts
        
        # Source code
        zip -r artifacts/SCAM-Source.zip . \
          -x "*.git*" \
          -x "*build/*" \
          -x "*artifacts/*" \
          -x "*.DS_Store"
        
        # Copy IPA if exists
        if [ -f build/SCAM.ipa ]; then
          cp build/SCAM.ipa artifacts/
        fi
        
        echo "ðŸ“¦ Artifacts packaged"
    
    - name: Upload IPA
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SCAM-iOS-App
        path: artifacts/SCAM.ipa
        retention-days: 30
    
    - name: Upload Source
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SCAM-Source-Code
        path: artifacts/SCAM-Source.zip
        retention-days: 30
    
    - name: Build Summary
      run: |
        echo "## âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**SCAM Messenger** iOS app built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
        echo "- Swift files: $(find . -name '*.swift' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Views: $(find Views -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Models: $(find Models -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- ViewModels: $(find ViewModels -name '*.swift' 2>/dev/null | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "- **SCAM.ipa** - iOS app (unsigned, for simulator)" >> $GITHUB_STEP_SUMMARY
        echo "- **Source code** - Complete project files" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš ï¸ Note" >> $GITHUB_STEP_SUMMARY
        echo "This is an unsigned build. To install on device, you need to:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open project in Xcode" >> $GITHUB_STEP_SUMMARY
        echo "2. Select your team for code signing" >> $GITHUB_STEP_SUMMARY
        echo "3. Build and run on your device" >> $GITHUB_STEP_SUMMARY
